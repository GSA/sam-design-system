<fieldset class="usa-fieldset">
  <legend class="usa-sr-only">{{ to.label }}</legend>
  <ul class="sds-list--no-bullets">
    <li class="grid-row" *ngIf="to.selectAllOption">
      <div>
        <input [id]="id + '_Select'" type="checkbox" class="usa-checkbox__input" value="value" [checked]="allComplete"
          [attr.aria-checked]="ariaChecked" (change)="setAll($event)" />
        <label class="usa-checkbox__label" [attr.aria-checked]="ariaChecked" [for]="id + '_Select'">
          <span [innerHtml]="to.label"></span>
        </label>

      </div>
      <div *ngIf="to.selectTooltipText">
        <p #tipContent1 [ngClass]="to.tooltipClass" class="margin-1" [innerHTML]="to.selectTooltipText"></p>
        <usa-icon class="padding-top-105 margin-left-1"
          [position]="to.selecttooltipPosition ? to.selecttooltipPosition :'right'" [sdsTooltip]="tipContent1"
          [size]="'lg'" [icon]="'info-circle'"></usa-icon>
      </div>

      <div *ngIf="to.expandableOptions">
        <button type="button" class="sds-button padding-top-0" [attr.aria-expanded]="!to.expandedOptions"
          [attr.aria-controls]="id + 'collapseID'" (click)="to.expandedOptions = !to.expandedOptions">
          <span class="usa-sr-only">expand/collapsed</span>
          <usa-icon [icon]="to.expandedOptions ?'caret-down-fill': 'caret-up-fill'" [size]="'1x'">
          </usa-icon>

        </button>
      </div>
    </li>
    <li [id]="id+ 'collapseID'" [sdsCollapse]="to.expandedOptions"
      [ngClass]="{'margin-left-4 margin-top-0': to.selectAllOption}">
      <ul class="sds-list--no-bullets">
        <li class="grid-row" *ngFor="let option of (to.options | formlySelectOptions: field | async); let i = index">
          <div *ngIf="option.group">
            <label class="usa-label" style="margin-top: 1.5rem; font-weight: bold;">{{option.label}}</label>
        <li class="grid-row" *ngFor="let opt of option.group; let j = index">
          <input class="usa-checkbox__input" [id]="id + '_' + i + j" type="checkbox" [name]="id + '_name_' + i + j"
            [disabled]="opt.disabled" [value]="opt.value" [formlyAttributes]="field"
            (change)="onChange(opt.value, $event.target.checked)" [checked]="isChecked(opt)" />
          <label class="usa-checkbox__label" [for]="id + '_' + i + j">
            <span [innerHtml]="opt.label"></span>
          </label>
        </li>
        </div>

        <div *ngIf="!option.group">
          <input class="usa-checkbox__input" [id]="id + '_' + i" type="checkbox" [name]="id + '_name_' + i"
            [disabled]="option.disabled" [value]="option.value" [formlyAttributes]="field"
            (change)="onChange(option.value, $event.target.checked)" [checked]="isChecked(option)" />
          <label class="usa-checkbox__label" [for]="id + '_' + i">
            <!-- 
                The reference of options array through index is done intentionally here rather 
                than using local variable option because the formlySelectOptions pipe transforms 
                each option such that they lose all properties except label, value, and disabled 
            -->
            <!-- <span *ngIf="to.options[i].group"> {{to.options[i] | json}}</span> -->
            <span *ngIf="to.options[i].tagText" class="usa-tag"
              [ngClass]="to.options[i].tagClass ? to.options[i].tagClass : 'sds-tag--info-white'">
              {{to.options[i].tagText}}
            </span>
            <span [innerHtml]="option.label"></span>
          </label>
        </div>

        <div *ngIf="to.options[i].tooltipText" class="margin-top-1 margin-left-1">
          <p #tipContent [ngClass]="to.options[i].tooltipClass" class="margin-1"
            [innerHTML]="to.options[i].tooltipText"></p>
          <usa-icon [position]="to.options[i].tooltipPosition ? to.options[i].tooltipPosition :'right'"
            [sdsTooltip]="tipContent" [size]="'lg'" [icon]="'info-circle'"></usa-icon>
        </div>
    </li>
  </ul>
  </li>
  </ul>
</fieldset>
