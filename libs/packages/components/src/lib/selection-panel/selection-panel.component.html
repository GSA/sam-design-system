<div class="sds-card sds-card--collapsible" [ngClass]="{'sds-card--collapsed': !panelExpanded}">
  <div role="button" class="sds-card__header sds-card__header--action" [attr.aria-expanded]="panelExpanded"
    aria-controls="panelBody" tabindex="0" [attr.aria-label]="title"
    (click)="panelExpanded = !panelExpanded"
    (keyup.enter)="panelExpanded = !panelExpanded"
    >
    <div class="sds-card__title">{{title}}<br />
      <span *ngIf="mainParentOfCurrentSelection"
        role="list"
        class="sds-card__subtitle"
        (click)="onMainPanelHeaderClicked($event)"
        (keyup.enter)="onMainPanelHeaderClicked($event)"
        [attr.aria-label]="mainParentOfCurrentSelection.text + 'Press to navigate back to main list'"
        tabindex="0"
      >
        {{mainParentOfCurrentSelection.text}}
      </span>
    </div>

    <div class="sds-card__action sds-card__collapse"></div>
  </div>

  <!-- Move focus here after an item has been selected so that next tab press moves to panel content-->
  <div #startOfPanelBody class="sr-only" tabindex="-1"></div>

  <div class="sds-card__body sds-card__body--accent-cool" id="panelBody">
    <ng-container *ngIf="isTopSection; else subPanel">
      <ul class="usa-sidenav usa-sidenav--styled">
        <li *ngFor="let panelItem of panelItemsOnDisplay" class="usa-sidenav__item"
          [ngClass]="{'usa-current': currentSelection && panelItem.id === currentSelection.id}">
          <a href="javascript:void(0);" (click)="onPanelItemClick(panelItem)">{{panelItem.text}}</a>
        </li>
      </ul>
    </ng-container>

    <ng-template #subPanel>
      <ul class="usa-sidenav sds-list">
        <li *ngFor="let panelItem of panelItemsOnDisplay" class="usa-sidenav__item">
          <ng-container [ngTemplateOutlet]="subPanelTemplate" [ngTemplateOutletContext]="{$implicit:panelItem}">
          </ng-container>
        </li>
      </ul>

      <ng-template #subPanelTemplate let-panelItem>
        <a href="javascript:void(0);" 
        [ngClass]="{
          'text-secondary': !currentSelection || panelItem.id != currentSelection.id, 
          'usa-link usa-link--active': currentSelection && panelItem.id === currentSelection.id
        }"
        (click)="onPanelItemClick(panelItem)">
        {{panelItem.text}}</a>
        <ul *ngIf="panelItem.children" class="usa-sidenav__sublist">
          <li *ngFor="let panelItem of panelItem.children" class="sidenav__item">
            <ng-container [ngTemplateOutlet]="subPanelTemplate" [ngTemplateOutletContext]="{$implicit:panelItem}">
            </ng-container>
          </li>
        </ul>
      </ng-template>
    </ng-template>
  </div>
</div>