<div class="condensed margin-top-2">
    <div class="grid-row grid-gap">
      <div class="desktop:grid-col-4 tablet-lg:grid-col-12 mobile-lg:grid-col-12 margin-bottom-3">
        <div class="sds-card">
          <div class="sds-card__body sds-card__body--accent-cool">

            <ul class="usa-sidenav usa-sidenav--styled">
              <li *ngFor="let step of getDisplayedSteps(stepTemplates); let i = index;" class="usa-sidenav__item"
                [ngClass]="{
                  'usa-current':  _currentStep?.id === step.id
                }">
                <ng-container [ngTemplateOutlet]="sidenavItem" [ngTemplateOutletContext]="{$implicit: step}">
                </ng-container>
                <ng-container [ngTemplateOutlet]="subPanelTemplate" [ngTemplateOutletContext]="{$implicit:step}">
                </ng-container>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="grid-col-fill">
        <ng-content></ng-content>

        <div class="grid-row grid-gap align-right margin-top-4">
          <div class="text-right margin-right-1" *ngIf="_currentStepIndex > 0">
            <button class="usa-button sds-button--circle usa-button--base usa-button--big padding-2"
              (click)="onPreviousStep()" [attr.id]="id + '-prevBtn'">
              <sds-icon [icon]="'chevron-left'"></sds-icon>
            </button>

            <label [attr.for]="id + '-prevBtn'" class="text-right usa-link cursor-pointer display-block margin-top-2">
              Back to
              <span class="display-block">{{_dataEntryStepsDef[_currentStepIndex - 1]?.text}}</span>
            </label>
          </div>
          <div class="margin-right-2">
            <button class="usa-button sds-button--circle usa-button--big usa-button--base padding-2"
              (click)="closeback();" [attr.id]="id + '-closeBtn'">
              <sds-icon [icon]="'x'"></sds-icon>
            </button>
            <label [attr.for]="id + '-closeBtn'" class="text-center usa-link cursor-pointer display-block margin-top-2">
              Close
            </label>
          </div>
          <div class="margin-right-2" *ngIf="!_currentStep?.isReview">
            <button class="usa-button sds-button--circle usa-button--big usa-button--base padding-2"
              [attr.id]="id + '-helpBtn'">
              <sds-icon [icon]="'question'"></sds-icon>
            </button>
            <label [attr.for]="id + '-helpBtn'" class="text-center usa-link cursor-pointer display-block margin-top-2">
              Help
            </label>
          </div>
          <div class="margin-right-2" *ngIf="!_currentStep?.isReview" (click)="onSaveClicked()"
            [attr.id]="id + '-saveBtn'">
            <button class="usa-button sds-button--circle usa-button--big usa-button--base padding-2">
              <sds-icon [icon]="'save'"></sds-icon>
            </button>
            <label [attr.for]="id + '-saveBtn'" class="text-center usa-link cursor-pointer display-block margin-top-2">
              Save
            </label>
          </div>
          <div class="margin-right-2"
            *ngIf="_currentStepIndex != _dataEntryStepsDef.length - 1 && !_currentStep?.isReview">
            <button cdkStepperNext
              class="usa-button sds-button--circle usa-button--base usa-button--big usa-button--active padding-2"
              (click)="onNextStep()" [attr.id]="id + '-nextBtn'">
              <sds-icon [icon]="'chevron-right'"></sds-icon>
            </button>
            <label [attr.for]="id + '-nextBtn'" class="text-left usa-link cursor-pointer display-block margin-top-2">
              Go to
              <span class="display-block">{{_dataEntryStepsDef[_currentStepIndex + 1]?.text}}</span>
            </label>
          </div>

        </div>


      </div>
    </div>
</div>

<ng-template #subPanelTemplate let-panelItem>
  <div *ngFor="let pItem of getDisplayedSteps(panelItem.children); let i = index;">
    <ul class="usa-sidenav usa-sidenav--styled bg-base-lighter margin-x-0">
      <li class="usa-sidenav__item  padding-left-3" [ngClass]="{'usa-current':  _currentStep?.id === pItem.id }">
        <ng-container [ngTemplateOutlet]="sidenavItem" [ngTemplateOutletContext]="{$implicit: pItem}"></ng-container>
      </li>
    </ul>
  </div>
</ng-template>

<ng-template #sidenavItem let-step>
  <ng-container [ngSwitch]="step.mode">
    <span *ngSwitchCase="navigationMode.LABEL">
      <span class="margin-left-1 padding-x-2 padding-y-1 display-block text-bold">
        {{step.text}}
      </span>
    </span>
    <a *ngSwitchDefault href="javascript:void(0);" (click)="changeStep(step.id)"
      [ngClass]="{'cursor-default opacity-60': step.isReview && _isReviewAndSubmitDisabled}"
    >
      <ng-container [ngTemplateOutlet]="sidenavIcon" [ngTemplateOutletContext]="{$implicit: step}"></ng-container>
      <span class="margin-left-1">
        {{step.text}}
      </span>
    </a>
  </ng-container>
</ng-template>

<ng-template #sidenavIcon let-step>
  <ng-container [ngSwitch]="step.valid">
    <span *ngSwitchCase="true" class="usa-button sds-button--circle">
      <sds-icon [icon]="'check'"></sds-icon>
    </span>
    <span *ngSwitchCase="false" class="usa-button sds-button--circle sds-button--danger">
      <sds-icon [icon]="'x'"></sds-icon>
    </span>
    <span *ngSwitchDefault>
      <sds-icon [icon]="'not-completed'"></sds-icon>
    </span>
  </ng-container>
</ng-template>